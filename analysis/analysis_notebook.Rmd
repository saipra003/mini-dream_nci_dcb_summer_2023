---
title: "Mini-DREAM Analysis"
output: html_notebook
---
The purpose of this notebook is to detail a few approaches to the mini-DREAM challenge status in the `README.md` file. Feel free to make changes and extend the work in this notebook.

## Understanding the Data
Before, we jump into the cool visualization steps, we need to understand what we're dealing with. The files we're working with in this project are pretty easy to open with Excel or Keynote (if you're a Mac user), but in the future, you may work with larger datasets that you cannot open through these programs. Fortunately, we can read the .csv file and get a sample of what the data looks like.

```{r Load data and display top rows}
library(tidyverse)
data <- read_csv("C:/Users/saipr/mini-dream_nci_dcb_summer_2023/data/MDA-PCa-2b control vs enzaR DifferentialExpression.csv")
head(data)
```
Let's breakdown what each of these columns means:
* GeneID	ENSEMBL gene ID
* GeneName	Gene name
* IsCoding	Is the gene a known protein coding gene
* log2FoldChange	Log2(fold-change)
* stat	Wald test statistic
* pvalue	p-value
* padj	FDR corrected p-value
* <Sample ID>	Normalized expression value for the specific <Sample ID>

## Dimensionality Reduction
It's hard to see differences in the expression of this many genes, so it would be interesting to see how the n-dimensional data would look in 2D. We can use dimensionality reduction to do this. 
```{r}
data_prot_cod <- data[data$IsCoding == 'TRUE',] # filter for protein coding data
data_prot_cod <- data_prot_cod[,!(names(data_prot_cod) %in% c("GeneName","IsCoding","log2FoldChange", 'stat', 'pvalue', 'padj'))]
# Create a matrix from our table of counts
pca_matrix <- data_prot_cod %>% 
  # make the "gene" column become the rownames of the table
  column_to_rownames("GeneID") %>% 
  # coerce to a matrix
  as.matrix() %>% 
  # transpose the matrix so that rows = samples and columns = variables
  t()

# Perform the PCA
sample_pca <- prcomp(pca_matrix)
# The PC scores are stored in the "x" value of the prcomp object
pc_scores <- sample_pca$x

pc_scores <- pc_scores %>% 
  # convert to a tibble retaining the sample names as a new column
  as_tibble(rownames = "sample")

pc_scores %>% 
  # create the plot
  ggplot(aes(x = PC1, y = PC2)) +
  geom_point(aes(color = condition))
```
Points appear to cluster well which is what we expect. But we want to create a higher quality PCA plot for presentation purposes. 

```{r}
library(PCAtools)

pca_matrix_2 <- data_prot_cod %>% 
  # make the "gene" column become the rownames of the table
  column_to_rownames("GeneID") %>% 
  # coerce to a matrix
  as.matrix()

metadata <- data.frame(pc_scores$condition, row.names = pc_scores$sample)
p <- pca(pca_matrix_2, metadata = metadata, removeVar = 0.1)
biplot(p,
       colby = 'pc_scores.condition', 
       colkey = c('treated' = 'forestgreen', 'control' = 'purple'),
       gridlines.major = FALSE, 
       gridlines.minor = FALSE,
       title = "Principal Components Analysis",
       subtitle = "Enzalutamide vs. DMSO",
       titleLabSize = 16,
       subtitleLabSize = 12,
       # encircle config
      encircle = TRUE,
      encircleFill = TRUE,
) + theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks.y=element_blank(),
      plot.title = element_text(hjust = 0.5),
      plot.subtitle=element_text(hjust=0.5)
      )
setwd("C:/Users/saipr/mini-dream_nci_dcb_summer_2023/analysis/plots/")
ggsave("principal_components_analysis.png", dpi = 300)
```
When doing differential expression analysis it's important to see what genes and pathways are differentially expressed. To visualize the differential expression of certain genes, we can create a volacano plot. 

```{r}
setwd("C:/Users/saipr/mini-dream_nci_dcb_summer_2023/analysis/")

library(EnhancedVolcano)
library(org.Hs.eg.db)

# convert Ensembl ID's to gene symbols
ens <- data$GeneID
symbols <- mapIds(org.Hs.eg.db, keys = ens,
column = c('SYMBOL'), keytype = 'ENSEMBL')
symbols <- symbols[!is.na(symbols)]
symbols <- symbols[match(data$GeneID, names(symbols))]

# get char vector of top 5 differentially expressed genes in each direction
data <- data[order(data$log2FoldChange),]

# filter for protein coding genes
data_prot_coding <- data[data$IsCoding == "TRUE",]

# create volcano plot
 EnhancedVolcano(data_prot_coding,
    lab = data_prot_coding$GeneName,
    x = 'log2FoldChange',
    y = 'pvalue',
    selectLab = c('AR'),
    xlab = bquote(~Log[2]~ 'fold change'),
    pCutoff = 10e-14,
    FCcutoff = 2.0,
    pointSize = 4.0,
    labSize = 6.0,
    labCol = 'black',
    labFace = 'bold',
    boxedLabels = TRUE,
    colAlpha = 4/5,
    legendPosition = 'right',
    legendLabSize = 14,
    legendIconSize = 4.0,
    drawConnectors = TRUE,
    widthConnectors = 1.0,
    colConnectors = 'black')
 ggsave(filename = "differential_expression_volcano_plot.png", dpi = 300, type = "png", height = 20, width = 20)
```



